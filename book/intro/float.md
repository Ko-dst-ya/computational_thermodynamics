# Числа с плавающей точкой

% TODO
% Float64
% распределение
% https://stackoverflow.com/questions/249467/what-is-a-simple-example-of-floating-point-rounding-error
% неассоциативность операций

Множество действительных чисел $\real$ неограничено и непрерывно.
Однако, в вычислительной практике используется множество *чисел с плавающей точкой* $\floatset\subset\real$, которое ограничено и дискретно.

Множество **чисел с плавающей точкой** $\floatset$ состоит из нуля и чисел вида

```{index} ! число с плавающей точкой
```

```{math}
:label: floatpoint
\pm (1 + f) \times 2^n,
```

где целое число $n\in\integer$ называют **экспонентой**, а $1+f$ **мантиссой**, при этом $f$ имеет вид

```{margin}
Из представления {eq}`mantissa` следует, что $f$ можно назвать дробной частью мантиссы.
```

```{math}
:label: mantissa
f = \sum_{i=1}^d b_i \, 2^{-i}, \quad b_i\in\{0,1\},
```

где натуральное $d$ называют (в данном случае) двоичной **точностью**.

Используя нотацию из позиционных систем счисления, можно записать *в двоичной системе*

```{math}
1 + f = 1 + \overline{b_1 b_2 ... b_d} = 1.\overline{b_1 b_2 ... b_d} \in [1,2).
```

Отсюда видно, что ближайшие мантисcы отстоят друг от друга на $2^{-d}$ (последний бит $b_d$).
Поэтому, между числами $2^n$ и $2^{n+1}$ находится $2^d$ равномерно распределённых чисел.
В свою очередь, отсюда следует, что числа с плавающей точной *распределены неравномерно* на числовой оси.

```{admonition} Пример: числа с плавающей точкой
:class: tip

Рассмотрим числа с точностью $d = 3$. Для $n=0$ получим $8$ чисел

$$
1, \: 1 + \frac{1}{8}, \: 1 + \frac{1}{4}, \: 1 + \frac{1}{4} + \frac{1}{8}, \:
1 + \frac{1}{2}, \: 1 + \frac{1}{2} + \frac{1}{8}, \: 1 + \frac{1}{2} + \frac{1}{4}, \:
1 + \frac{1}{2} + \frac{1}{4} + \frac{1}{8} = 1 + \frac{7}{8}.
$$

которые заключены в полуинтервале $[1,2)$ с промежутком $2^0 2^{-3} = 1/8$.

В свою очередь, для $n=1$ получим $8$ чисел в полуинтервале $[2, 4)$ с промежутком $2^1 2^{-3} = 1/4$

$$
(1+0)\times 2^1 = 2, \quad \bigg(1 + \frac{1}{8}\bigg) \times 2^1 = 2 + \frac{1}{4}
, \quad ..., \quad \bigg(1 + \frac{1}{2} + \frac{1}{4} + \frac{1}{8}\bigg) \times 2^1 = 3 + \frac{3}{4}.
$$

Аналогично, для $n=-1$ получим $8$ чисел в полуинтервале $[1/2,1)$ с промежуком $2^{-1}2^{-3}=1/16$.
```

```{margin}
Для чисел с плавающей точкой верно равенство $1 + \macheps / 2 = 1$.
```

Из примера видно, что наименьшее число с плавающей точкой, большее $1$ это $1 + 2^{-d}$. Разницу между этими числами $2^{-d}$ называют **машинным нулём** (машинным эпсилон, машинной точностью) $\macheps$.

Поскольку числа с плавающей точкой имеют конечную точность, сделаем оценку лучшего приближения.
Пусть $\float(x)\in\floatset$ ближайшее к действительному $x\in\real$ число с плавающей точкой. Расстояние для чисел в промежутке $[2^n, 2^{n+1})$ равняется $2^n \macheps = 2^{n-d}$. Поэтому число $x$ находится на далее чем на $2^{n-d} / 2 = 2^{n-d-1}$ от $\float(x)$. Относительная ошибка приближения тогда

```{math}
\frac{|\float(x)-x|}{|x|} \le \frac{2^{n-d-1}}{2^n} \le \frac{1}{2}\macheps.
```

## Числа двойной точности
```{margin}
Последняя версия стандарта &ndash; IEEE 754-2019.

Поскольку в двоичном представлении первая цифра мантиссы нормализованного числа всегда 1, то её смысла хранить нет.
```
Число с плавающей точкой двойной точности `Float64` определил стандарт IEEE 754-1985.
Для `Float64` всего отводится 64 бита: один под знак числа, 11 под экспоненту и 52 под дробную часть мантиссы $f$.


```
  s eeeeeeeeeee mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm
  ↑  экспонента                        мантисса
знак
1 бит  11 бит                           52 бита
```

Таким образом для `Float64` $d=52$ {eq}`mantissa`, а машинная точность $\macheps$ составляет

```{math}
\macheps = 2^{-52} \approx 2.2 \times 10^{-16}.
```

Экспонента $n$ {eq}`floatpoint` принимает значения $-1022 \le n \le 1023$. Максимальное значение составляет почти $2^{1024} \approx 2 \times 2^{308}$. Числа крупнее принимают специальное значение-бесконечность `Inf`. Наименьшим положительным числом является $2^{-1022} \approx 2 \times 10^{-308}$, меньшие его становятся нулём. Отрицательные аналоги работают схожим образом.

Стоит отметить, что нулей в `Float64`, как и бесконечностей, два: `+0` и `-0`.

```{margin}
Да, на ноль делить можно.
```
Кроме того, существует ещё одно специальное значение `NaN` или **Not a Number**. Оно появляется в результате неопределённых операций: `0/0`, `Inf/Inf` и операций, в которых участвует `NaN`, что приводит к распространению `NaN` в вычислениях.

## Особенности арифметики чисел с плавающей точкой

Конечная точность чисел с плавающей точкой приводит к **ошибкам округления**. Рассмотрим на примерах ниже.

```{admonition} Пример: ошибки округления 1
:class: tip

Пусть требуется сложить $2.25 + 1.125$ c двоичной точностью $d=3$
Тогда сложение представится в виде

$$
\float(2.25) + \float(1.125) = \bigg(1+\frac{1}{8}\bigg)\times 2^1 + \bigg(1+\frac{1}{8}\bigg)\times 2^0.
$$

Чтобы его выполнить, необходимо сначала выравнять экспоненты слагаемых

$$
\require{cancel}
\bigg(1+\frac{1}{8}\bigg)\times 2^1 + \bigg(\frac{1}{2}+\cancel{\frac{1}{16}}\bigg)\times 2^1.
$$

На этом этапе происходит обрезание $1/16$, поскольку $1/16$ меньше точности $1/8$, с которой можно задать мантиссу.

Когда экспонентны выравнены, можно сложить мантиссы $(1 + 1/8) + (1/2)$. Получаем результат

$$
\bigg(1+ \frac{1}{2}+\frac{1}{8}\bigg)\times 2^1 = 3.25,
$$

который не равен сложению в действительныйх числах $2.25 + 1.125 = 3.325$.
```

% Арифметика в числах с плавающей точкой в общем случае *неассоциативна*. Поскольку точность представления числа в полуинтервалах $[2^n, 2^{n+1})$ разная, то следует малые числа складывать с малыми, а крупные с крупными.
